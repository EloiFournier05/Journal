<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <title>Tracker</title>
  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffffcc;
      --text:#111114;
      --muted:#6b6b73;
      --border:#e6e6ea;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
      --radius2:14px;
      --blur: saturate(180%) blur(16px);

      /* Mobile first sizing */
      --pad:14px;
      --gap:12px;
      --tap:44px;
      --hm:12px;
      --hmGap:4px;
      --monthH:42px;
      --h1:24px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

.app{
  max-width: 100%;
  margin: 0 auto;
  min-height: 100%;
  padding: 16px 14px 104px;
}


.topbar{
  position: sticky;
  top: 0;
  z-index: 5;

  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;

  padding: 10px 0 12px;
  margin: 0 0 12px;

  background: rgba(245,245,247,.78);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
}


    .title{ line-height:1.05; }
    .title h1{
      margin:0;
      font-size:var(--h1);
      letter-spacing:-0.02em;
    }
    .title p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
    }

.controls{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  align-items: stretch;
}


.pill{
  height: 44px;
  padding: 0 12px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.92);
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 8px 24px rgba(0,0,0,.06);
}


    select,button,input,textarea{ font:inherit; color:inherit; }
    select{ border:none; outline:none; background:transparent; cursor:pointer; }

button{
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.92);
  border-radius: 14px;
  height: 44px;
  padding: 0 14px;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(0,0,0,.06);
  -webkit-tap-highlight-color: transparent;
}

    button:active{ transform:translateY(1px); }

    #todayBtn, #lockBtn{ width: 100%; }
.controls > .pill{ width: 100%; }

    .gridWrap{ display:grid; grid-template-columns:1fr; gap:var(--gap); }

.card{
  background: rgba(255,255,255,.78);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border: 1px solid rgba(0,0,0,.08);
  border-radius: 20px;
  box-shadow: 0 14px 40px rgba(0,0,0,.10);
  padding: 14px;
}


.stats{
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  align-items: start;
}
.statGroup{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

    }
    .stat{
      min-width:0;
      padding:10px 12px;
      border-radius:var(--radius2);
      border:1px solid var(--border);
      background:#fff;
    }
    .stat .k{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .stat .v{ font-size:18px; letter-spacing:-0.01em; font-weight:600; }

    .hint{ color:var(--muted); font-size:12px; margin:0; }

    /* Year heatmap */
    .heatmap{ overflow-x:auto; padding-bottom:4px; -webkit-overflow-scrolling: touch; }
    .hmGrid{
      display:grid;
      grid-auto-flow:column;
      grid-auto-columns:var(--hm);
      grid-template-rows:repeat(7,var(--hm));
      gap:var(--hmGap);
      width:max-content;
      padding:8px 2px 2px;
    }
    .cell{
      width:var(--hm);
      height:var(--hm);
      border-radius:4px;
      border:1px solid rgba(0,0,0,.06);
      background:#e9e9ef;
      cursor:pointer;
    }

    /* Month grid */
    .monthWrap{ display:grid; gap:10px; }
    .monthHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .monthTitle{ font-weight:900; letter-spacing:-0.01em; }
    .monthGrid{ display:grid; grid-template-columns:repeat(7, 1fr); gap:6px; }
    .dow{
      font-size:11px;
      color:var(--muted);
      text-align:center;
      padding:4px 0 2px;
    }
    .dayCell{
      height:var(--monthH);
      border-radius:12px;
      border:1px solid rgba(0,0,0,.06);
      background:#e9e9ef;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      padding:6px 8px;
      cursor:pointer;
      position:relative;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .dayCell .num{
      font-size:12px;
      font-weight:900;
      color:rgba(0,0,0,.75);
      mix-blend-mode:multiply;
    }
    .dayCell.out{ opacity:.35; }
    .dayCell.selected{
      outline:3px solid rgba(0,0,0,.18);
      outline-offset:2px;
    }

    .legend{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
    }
    .swatches{ display:flex; gap:6px; align-items:center; }
    .sw{ width:14px; height:14px; border-radius:4px; border:1px solid rgba(0,0,0,.06); }

    .editorHeader{
      display:flex;
      flex-direction:column;     /* mobile */
      align-items:stretch;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .editorTitle{ font-weight:900; letter-spacing:-0.01em; }
    .tiny{ font-size:12px; color:var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; }

    .section{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
    }
    .sectionTitle{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:0.01em;
      text-transform:uppercase;
    }

    .stepper{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .stepper .value{ font-size:22px; font-weight:900; letter-spacing:-0.02em; }
    .btns{ display:flex; gap:8px; }
    .iconBtn{
      width:var(--tap);
      height:var(--tap);
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-size:18px;
      font-weight:900;
      box-shadow:0 6px 18px rgba(0,0,0,.05);
      -webkit-tap-highlight-color: transparent;
    }

    .presets{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      height:34px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      color:var(--muted);
      -webkit-tap-highlight-color: transparent;
    }
    .chip.active{
      color:var(--text);
      border-color:rgba(0,0,0,.14);
      box-shadow:0 8px 18px rgba(0,0,0,.08);
    }

    .palette{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .dot{
      width:28px;
      height:28px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .dot.selected{
      outline:3px solid rgba(0,0,0,.18);
      outline-offset:2px;
    }

    textarea{
      width:100%;
      min-height:86px;
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px 12px;
      resize:vertical;
      outline:none;
    }
    .countRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:8px; }

    .danger{ color:#b42318; border-color:rgba(180,35,24,.25); }
    .hidden{ display:none; }

    .tabs{
      position:fixed;
      left:0; right:0; bottom:0;
      background:rgba(255,255,255,.85);
      backdrop-filter:var(--blur);
      -webkit-backdrop-filter:var(--blur);
      border-top:1px solid var(--border);
      padding:10px 14px 18px;
    }
    .tabbar{
      max-width:560px;           /* mobile */
      margin:0 auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .tab{
      height:44px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:var(--muted);
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(0,0,0,.12);
      box-shadow:0 8px 22px rgba(0,0,0,.08);
    }

    /* PIN overlay */
    .pinOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .pinOverlay.show{ display:flex; }
    .pinCard{
      width:min(420px, 100%);
      background:rgba(255,255,255,.92);
      backdrop-filter:var(--blur);
      -webkit-backdrop-filter:var(--blur);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.22);
      padding:16px;
    }
    .pinTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .pinTitle{ font-weight:900; letter-spacing:-0.01em; font-size:18px; margin:0; }
    .pinSub{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .pinDots{ display:flex; gap:10px; justify-content:center; margin:14px 0 10px; }
    .dotP{
      width:10px; height:10px; border-radius:99px;
      border:1px solid rgba(0,0,0,.18);
      background:transparent;
    }
    .dotP.f{ background:rgba(0,0,0,.75); }
    .keypad{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .key{
      height:48px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.05);
      -webkit-tap-highlight-color: transparent;
    }
    .key.muted{ color:var(--muted); font-weight:800; }

    /* Desktop enhancements (opt-in) */
    @media (min-width: 820px){
      :root{ --pad:18px; --gap:14px; --hm:14px; --monthH:44px; --h1:28px; }
      .app{ max-width:980px; padding:18px 18px 92px; }
      .topbar{ flex-direction:row; align-items:flex-end; justify-content:space-between; }
      .controls{ justify-content:flex-end; }
      .stats{ flex-direction:row; align-items:center; }
      .statGroup{ display:flex; }
      .editorHeader{ flex-direction:row; align-items:center; }
      .tabbar{ max-width:980px; }
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <div class="topbar">
      <div class="title">
        <h1 id="pageTitle">Journal</h1>
        <p id="pageSub">Vue année ou mois. Clique un jour puis saisis en dessous.</p>
      </div>

      <div class="controls">
        <div class="pill">
          <span style="color:var(--muted);font-size:12px;">Année</span>
          <select id="yearSelect"></select>
        </div>

        <div class="pill">
          <span style="color:var(--muted);font-size:12px;">Vue</span>
          <select id="viewSelect">
            <option value="year">Année</option>
            <option value="month">Mois</option>
          </select>
        </div>

        <button id="todayBtn">Aujourd’hui</button>
        <button id="lockBtn">Verrou</button>
      </div>
    </div>

    <div class="gridWrap">
      <div class="card">
        <div class="stats">
          <div class="statGroup">
            <div class="stat">
              <div class="k" id="k1">Jours avec note</div>
              <div class="v" id="v1">0</div>
            </div>
            <div class="stat">
              <div class="k" id="k2">Jours colorés</div>
              <div class="v" id="v2">0</div>
            </div>
          </div>
          <p class="hint" id="hint">Les jours non saisis restent neutres</p>
        </div>

        <div id="yearView" class="heatmap">
          <div id="hmGrid" class="hmGrid"></div>
        </div>

        <div id="monthView" class="monthWrap hidden">
          <div class="monthHeader">
            <div class="monthTitle" id="monthTitle">-</div>
            <div class="controls" style="gap:8px;">
              <button id="prevMonth">◀</button>
              <button id="nextMonth">▶</button>
            </div>
          </div>

          <div class="monthGrid" id="dowRow"></div>
          <div class="monthGrid" id="monthGrid"></div>
        </div>

        <div class="legend" id="legend"></div>
      </div>

      <div class="card" id="editorCard">
        <div class="editorHeader">
          <div>
            <div class="editorTitle" id="editorTitle">Saisie</div>
            <div class="tiny" id="editorSub">Sélectionne un jour pour saisir</div>
          </div>
          <div class="row">
            <button id="saveBtn" class="hidden">Enregistrer</button>
            <button id="clearBtn" class="hidden danger">Effacer</button>
          </div>
        </div>

        <div id="editorAlcohol" class="section hidden">
          <div class="sectionTitle">Alcool</div>
          <div class="stepper">
            <div>
              <div class="tiny">Doses bar (jour)</div>
              <div class="value"><span id="doseValue">0</span></div>
            </div>
            <div class="btns">
              <button class="iconBtn" id="minusDose" aria-label="Moins">−</button>
              <button class="iconBtn" id="plusDose" aria-label="Plus">+</button>
            </div>
          </div>
          <div class="presets" id="dosePresets"></div>
        </div>

        <div id="editorJournal" class="section hidden">
          <div class="sectionTitle">Journal</div>
          <div class="tiny" style="margin-bottom:10px;">Couleur du jour</div>
          <div class="palette" id="palette"></div>

          <div style="height:12px"></div>
          <div class="tiny" style="margin-bottom:8px;">Phrase de résumé (120 caractères max)</div>
          <textarea id="noteInput" placeholder="Une phrase courte."></textarea>
          <div class="countRow">
            <div class="tiny">1 phrase, 1 idée.</div>
            <div class="tiny"><span id="count">0</span>/120</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <div class="tabbar">
      <div class="tab" id="tabAlcohol">Alcool</div>
      <div class="tab active" id="tabJournal">Journal</div>
    </div>
  </div>

  <div class="pinOverlay" id="pinOverlay" aria-modal="true">
    <div class="pinCard">
      <div class="pinTop">
        <div>
          <p class="pinTitle" id="pinTitle">Code PIN</p>
          <p class="pinSub" id="pinSub">Entre ton code pour déverrouiller</p>
        </div>
        <button id="pinCancel" class="hidden">Annuler</button>
      </div>

      <div class="pinDots" id="pinDots"></div>
      <div class="keypad" id="keypad"></div>
      <div style="margin-top:10px;" class="tiny" id="pinHint"></div>
    </div>
  </div>

  <script>
    (function(){
      const STORAGE_KEY = "tracker.v2";
      const PIN_KEY = "tracker.pin.v1"; // { salt, hash }

      const state = {
        page: "journal",          // default journal
        year: new Date().getFullYear(),
        view: "year",
        monthIndex: new Date().getMonth(),
        selectedDate: null,
        data: { days: {} },
        unlocked: false
      };

      // Alcool:
      // vert: 0
      // bleu: 1-2
      // orange: 3-5
      // rouge: 6-10
      // noir: 11+
      function alcoholColor(doses){
        if(doses == null) return "#e9e9ef";
        const n = Math.max(0, Number(doses));
        if(n === 0) return "#23c55e";
        if(n <= 2) return "#3b82f6";
        if(n <= 5) return "#f59e0b";
        if(n <= 10) return "#ef4444";
        return "#111114";
      }

      const moodPalette = [
        "#23c55e","#3b82f6","#a855f7","#f59e0b",
        "#ef4444","#64748b","#111114","#f97316"
      ];

      const $ = (id) => document.getElementById(id);

      function iso(d){
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const da = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${da}`;
      }
      function parseISO(s){
        const [y,m,d] = s.split("-").map(Number);
        return new Date(y, m-1, d);
      }

      function dayOfWeekMon0(date){
        const js = date.getDay();
        return (js + 6) % 7;
      }
      function startOfYear(year){ return new Date(year,0,1); }
      function endOfYear(year){ return new Date(year,11,31); }

      function getDay(dateStr){
        return state.data.days[dateStr] || {};
      }
      function setDay(dateStr, patch){
        const cur = getDay(dateStr);
        const next = { ...cur, ...patch };

        if(next.moodNote != null) next.moodNote = String(next.moodNote);
        if(next.moodNote) next.moodNote = next.moodNote.slice(0,120);

        const empty =
          (next.alcoholDoses == null || next.alcoholDoses === "") &&
          (!next.moodColor) &&
          (!next.moodNote || next.moodNote.trim() === "");

        if(empty){
          delete state.data.days[dateStr];
        } else {
          if(next.alcoholDoses === "") next.alcoholDoses = null;
          state.data.days[dateStr] = next;
        }
        persist();
      }

      function load(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(raw){
            const parsed = JSON.parse(raw);
            if(parsed && parsed.days && typeof parsed.days === "object"){
              state.data.days = parsed.days;
            }
          }
        } catch(e) {}
      }
      function persist(){
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ days: state.data.days }));
      }

      function buildYearSelect(){
        const ys = $("yearSelect");
        ys.innerHTML = "";
        const nowY = new Date().getFullYear();
        const minY = nowY - 4;
        const maxY = nowY + 1;
        for(let y=minY; y<=maxY; y++){
          const opt = document.createElement("option");
          opt.value = String(y);
          opt.textContent = String(y);
          if(y === state.year) opt.selected = true;
          ys.appendChild(opt);
        }
        ys.onchange = () => {
          state.year = Number(ys.value);
          state.selectedDate = null;
          render();
        };
      }

      function buildLegend(){
        const el = $("legend");
        el.innerHTML = "";
        if(state.page === "alcohol"){
          const label = document.createElement("div");
          label.textContent = "Doses";
          el.appendChild(label);

          const sw = document.createElement("div");
          sw.className = "swatches";
          const colors = [
            {t:"0",c:"#23c55e"},
            {t:"1-2",c:"#3b82f6"},
            {t:"3-5",c:"#f59e0b"},
            {t:"6-10",c:"#ef4444"},
            {t:"11+",c:"#111114"}
          ];
          colors.forEach(s => {
            const d = document.createElement("div");
            d.className = "sw";
            d.style.background = s.c;
            d.title = s.t;
            sw.appendChild(d);
          });
          el.appendChild(sw);

          const txt = document.createElement("div");
          txt.textContent = "0 → 11+";
          el.appendChild(txt);
        } else {
          const label = document.createElement("div");
          label.textContent = "Couleurs";
          el.appendChild(label);

          const sw = document.createElement("div");
          sw.className = "swatches";
          moodPalette.slice(0,6).forEach(c => {
            const d = document.createElement("div");
            d.className = "sw";
            d.style.background = c;
            sw.appendChild(d);
          });
          el.appendChild(sw);

          const txt = document.createElement("div");
          txt.textContent = "Palette";
          el.appendChild(txt);
        }
      }

      function yearCells(year){
        const start = startOfYear(year);
        const end = endOfYear(year);

        const startDow = dayOfWeekMon0(start);
        const gridStart = new Date(start);
        gridStart.setDate(start.getDate() - startDow);

        const endDow = dayOfWeekMon0(end);
        const gridEnd = new Date(end);
        gridEnd.setDate(end.getDate() + (6 - endDow));

        const days = [];
        let cur = new Date(gridStart);
        while(cur <= gridEnd){
          days.push(new Date(cur));
          cur.setDate(cur.getDate()+1);
        }
        return { days, start, end };
      }

      function renderYearHeatmap(){
        const grid = $("hmGrid");
        grid.innerHTML = "";

        const { days, start, end } = yearCells(state.year);

        days.forEach(d => {
          const dateStr = iso(d);
          const inYear = (d >= start && d <= end);

          const cell = document.createElement("div");
          cell.className = "cell";
          if(!inYear) cell.style.opacity = "0.25";

          const entry = getDay(dateStr);
          if(state.page==="alcohol"){
            const doses = (typeof entry.alcoholDoses === "number") ? entry.alcoholDoses : null;
            cell.style.background = alcoholColor(doses);
            cell.title = `${dateStr} • ${doses == null ? "non saisi" : doses + " dose(s)"}`;
          } else {
            const c = entry.moodColor || null;
            cell.style.background = c ? c : "#e9e9ef";
            const note = entry.moodNote ? entry.moodNote.trim() : "";
            cell.title = `${dateStr}${c ? " • couleur" : " • non saisi"}${note ? " • " + note : ""}`;
          }

          cell.onclick = () => {
            state.selectedDate = dateStr;
            renderEditor();
            render();
          };

          if(state.selectedDate === dateStr){
            cell.style.outline = "3px solid rgba(0,0,0,.18)";
            cell.style.outlineOffset = "2px";
          }

          grid.appendChild(cell);
        });
      }

      function monthName(idx){
        const names = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
        return names[idx] || "-";
      }

      function renderMonthGrid(){
        const y = state.year;
        const m = state.monthIndex;
        $("monthTitle").textContent = `${monthName(m)} ${y}`;

        const dow = ["L","M","M","J","V","S","D"];
        const dowRow = $("dowRow");
        dowRow.innerHTML = "";
        dow.forEach(x=>{
          const d = document.createElement("div");
          d.className = "dow";
          d.textContent = x;
          dowRow.appendChild(d);
        });

        const first = new Date(y, m, 1);
        const last = new Date(y, m+1, 0);
        const startPad = dayOfWeekMon0(first);
        const totalDays = last.getDate();

        const grid = $("monthGrid");
        grid.innerHTML = "";

        const cells = 42;
        for(let i=0;i<cells;i++){
          const dayNum = i - startPad + 1;
          const cell = document.createElement("div");
          cell.className = "dayCell";

          let cellDate = null;
          if(dayNum < 1){
            const prev = new Date(y, m, dayNum);
            cellDate = prev;
            cell.classList.add("out");
          } else if(dayNum > totalDays){
            const next = new Date(y, m, dayNum);
            cellDate = next;
            cell.classList.add("out");
          } else {
            cellDate = new Date(y, m, dayNum);
          }

          const dateStr = iso(cellDate);
          const entry = getDay(dateStr);

          if(state.page==="alcohol"){
            const doses = (typeof entry.alcoholDoses === "number") ? entry.alcoholDoses : null;
            cell.style.background = alcoholColor(doses);
            cell.title = `${dateStr} • ${doses == null ? "non saisi" : doses + " dose(s)"}`;
          } else {
            const c = entry.moodColor || null;
            cell.style.background = c ? c : "#e9e9ef";
            const note = entry.moodNote ? entry.moodNote.trim() : "";
            cell.title = `${dateStr}${c ? " • couleur" : " • non saisi"}${note ? " • " + note : ""}`;
          }

          const num = document.createElement("div");
          num.className = "num";
          num.textContent = String(cellDate.getDate());
          cell.appendChild(num);

          if(state.selectedDate === dateStr) cell.classList.add("selected");

          cell.onclick = () => {
            state.selectedDate = dateStr;
            renderEditor();
            render();
          };

          grid.appendChild(cell);
        }
      }

      function computeStats(){
        const { start, end } = yearCells(state.year);

        let totalAlcohol = 0;
        let daysAlcohol = 0;

        let daysWithNote = 0;
        let daysWithColor = 0;

        for(const [dateStr, entry] of Object.entries(state.data.days)){
          const d = parseISO(dateStr);
          if(d < start || d > end) continue;

          if(state.page==="alcohol"){
            if(typeof entry.alcoholDoses === "number"){
              totalAlcohol += entry.alcoholDoses;
              daysAlcohol += 1;
            }
          } else {
            if(entry.moodNote && entry.moodNote.trim()) daysWithNote += 1;
            if(entry.moodColor) daysWithColor += 1;
          }
        }

        if(state.page==="alcohol"){
          $("k1").textContent = "Total annuel";
          $("k2").textContent = "Jours saisis";
          $("v1").textContent = String(totalAlcohol);
          $("v2").textContent = String(daysAlcohol);
        } else {
          $("k1").textContent = "Jours avec note";
          $("k2").textContent = "Jours colorés";
          $("v1").textContent = String(daysWithNote);
          $("v2").textContent = String(daysWithColor);
        }
      }

      function setPage(page){
        state.page = page;

        $("tabAlcohol").classList.toggle("active", page==="alcohol");
        $("tabJournal").classList.toggle("active", page==="journal");

        $("pageTitle").textContent = page==="alcohol" ? "Alcool" : "Journal";
        $("pageSub").textContent = "Vue année ou mois. Clique un jour puis saisis en dessous.";

        $("editorAlcohol").classList.toggle("hidden", page!=="alcohol");
        $("editorJournal").classList.toggle("hidden", page!=="journal");

        buildLegend();
        computeStats();
        renderEditor();
        render();
      }

      function setView(v){
        state.view = v;
        $("yearView").classList.toggle("hidden", v!=="year");
        $("monthView").classList.toggle("hidden", v!=="month");
        render();
      }

      function renderEditor(){
        const hasDate = !!state.selectedDate;
        $("saveBtn").classList.toggle("hidden", !hasDate);
        $("clearBtn").classList.toggle("hidden", !hasDate);

        if(!hasDate){
          $("editorTitle").textContent = "Saisie";
          $("editorSub").textContent = "Sélectionne un jour pour saisir";
          return;
        }

        const dateStr = state.selectedDate;
        $("editorTitle").textContent = dateStr;
        $("editorSub").textContent = state.page==="alcohol"
          ? "Entre tes doses bar du jour"
          : "Choisis une couleur et écris une phrase (120 max)";

        const entry = getDay(dateStr);

        if(state.page==="alcohol"){
          const doses = (typeof entry.alcoholDoses === "number") ? entry.alcoholDoses : 0;
          $("doseValue").textContent = String(doses);

          const presetWrap = $("dosePresets");
          presetWrap.innerHTML = "";
          const presets = [0,1,2,3,4,5,6,8,10,12];
          presets.forEach(p => {
            const b = document.createElement("button");
            b.className = "chip" + (p===doses ? " active" : "");
            b.textContent = String(p);
            b.onclick = () => {
              $("doseValue").textContent = String(p);
              [...presetWrap.querySelectorAll(".chip")].forEach(x => x.classList.remove("active"));
              b.classList.add("active");
            };
            presetWrap.appendChild(b);
          });

          function syncPresetActive(val){
            [...presetWrap.querySelectorAll(".chip")].forEach(x => x.classList.remove("active"));
            const match = [...presetWrap.querySelectorAll(".chip")].find(x => x.textContent === String(val));
            if(match) match.classList.add("active");
          }

          $("minusDose").onclick = () => {
            const cur = Number($("doseValue").textContent) || 0;
            const next = Math.max(0, cur-1);
            $("doseValue").textContent = String(next);
            syncPresetActive(next);
          };
          $("plusDose").onclick = () => {
            const cur = Number($("doseValue").textContent) || 0;
            const next = Math.min(50, cur+1);
            $("doseValue").textContent = String(next);
            syncPresetActive(next);
          };
        }

        if(state.page==="journal"){
          const palette = $("palette");
          palette.innerHTML = "";
          const selected = entry.moodColor || "";
          moodPalette.forEach(c => {
            const d = document.createElement("div");
            d.className = "dot" + (c===selected ? " selected" : "");
            d.style.background = c;
            d.onclick = () => {
              [...palette.querySelectorAll(".dot")].forEach(x => x.classList.remove("selected"));
              d.classList.add("selected");
            };
            palette.appendChild(d);
          });

          const txt = entry.moodNote || "";
          $("noteInput").value = txt.slice(0,120);
          $("count").textContent = String($("noteInput").value.length);
        }
      }

      function render(){
        buildYearSelect();
        $("viewSelect").value = state.view;

        computeStats();

        if(state.view==="year"){
          renderYearHeatmap();
        } else {
          renderMonthGrid();
        }
      }

      $("saveBtn").onclick = () => {
        if(!state.selectedDate) return;
        const dateStr = state.selectedDate;

        if(state.page==="alcohol"){
          const v = Number($("doseValue").textContent);
          setDay(dateStr, { alcoholDoses: Number.isFinite(v) ? v : null });
        } else {
          const sel = $("palette").querySelector(".dot.selected");
          const c = sel ? sel.style.background : "";
          const note = ($("noteInput").value || "").slice(0,120);
          setDay(dateStr, { moodColor: c, moodNote: note });
          $("count").textContent = String(note.length);
        }
        render();
      };

      $("clearBtn").onclick = () => {
        if(!state.selectedDate) return;
        const dateStr = state.selectedDate;
        setDay(dateStr, { alcoholDoses: null, moodColor: "", moodNote: "" });
        renderEditor();
        render();
      };

      $("viewSelect").onchange = () => setView($("viewSelect").value);

      $("prevMonth").onclick = () => {
        state.monthIndex -= 1;
        if(state.monthIndex < 0){ state.monthIndex = 11; state.year -= 1; }
        $("yearSelect").value = String(state.year);
        render();
      };
      $("nextMonth").onclick = () => {
        state.monthIndex += 1;
        if(state.monthIndex > 11){ state.monthIndex = 0; state.year += 1; }
        $("yearSelect").value = String(state.year);
        render();
      };

      $("tabAlcohol").onclick = () => setPage("alcohol");
      $("tabJournal").onclick = () => setPage("journal");

      $("todayBtn").onclick = () => {
        const today = new Date();
        state.year = today.getFullYear();
        state.monthIndex = today.getMonth();
        state.selectedDate = iso(today);
        $("yearSelect").value = String(state.year);
        renderEditor();
        render();
      };

      $("noteInput").addEventListener("input", () => {
        const v = ($("noteInput").value || "");
        if(v.length > 120){
          $("noteInput").value = v.slice(0,120);
        }
        $("count").textContent = String($("noteInput").value.length);
      });

      // PIN (verrou UI)
      function randHex(bytes){
        const a = new Uint8Array(bytes);
        crypto.getRandomValues(a);
        return [...a].map(b=>b.toString(16).padStart(2,"0")).join("");
      }
      async function sha256Hex(str){
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        const arr = Array.from(new Uint8Array(buf));
        return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
      }
      function getPinRecord(){
        try{
          const raw = localStorage.getItem(PIN_KEY);
          if(!raw) return null;
          const rec = JSON.parse(raw);
          if(rec && rec.salt && rec.hash) return rec;
          return null;
        } catch(e){ return null; }
      }
      function setPinRecord(rec){
        localStorage.setItem(PIN_KEY, JSON.stringify(rec));
      }

      const pinUI = { mode:"unlock", buf:"", first:"" };

      function showPin(mode){
        pinUI.mode = mode;
        pinUI.buf = "";
        $("pinOverlay").classList.add("show");
        $("pinCancel").classList.toggle("hidden", mode==="unlock");
        renderPin();
      }
      function hidePin(){
        $("pinOverlay").classList.remove("show");
      }

      function renderPin(){
        const dots = $("pinDots");
        dots.innerHTML = "";
        for(let i=0;i<4;i++){
          const d = document.createElement("div");
          d.className = "dotP" + (i < pinUI.buf.length ? " f" : "");
          dots.appendChild(d);
        }

        const rec = getPinRecord();

        if(pinUI.mode === "unlock"){
          $("pinTitle").textContent = "Code PIN";
          $("pinSub").textContent = "Entre ton code pour déverrouiller";
          $("pinHint").textContent = rec ? "" : "Aucun PIN trouvé. Tu vas en créer un.";
        } else if(pinUI.mode === "set1"){
          $("pinTitle").textContent = "Créer un PIN";
          $("pinSub").textContent = "Entre un code à 4 chiffres";
          $("pinHint").textContent = "Verrou d’interface uniquement.";
        } else {
          $("pinTitle").textContent = "Confirmer";
          $("pinSub").textContent = "Rentre le même code";
          $("pinHint").textContent = "";
        }
      }

      function buildKeypad(){
        const kp = $("keypad");
        kp.innerHTML = "";
        const keys = ["1","2","3","4","5","6","7","8","9","effacer","0","ok"];
        keys.forEach(k=>{
          const b = document.createElement("button");
          b.className = "key";
          if(k==="effacer" || k==="ok") b.classList.add("muted");
          b.textContent = (k==="effacer") ? "Effacer" : (k==="ok") ? "OK" : k;

          b.onclick = async () => {
            if(k==="effacer"){
              pinUI.buf = pinUI.buf.slice(0,-1);
              renderPin();
              return;
            }
            if(k==="ok"){
              await pinSubmit();
              return;
            }
            if(pinUI.buf.length >= 4) return;
            pinUI.buf += k;
            renderPin();
            if(pinUI.buf.length === 4) await pinSubmit();
          };
          kp.appendChild(b);
        });
      }

      async function pinSubmit(){
        if(pinUI.buf.length !== 4) return;

        const rec = getPinRecord();

        if(!rec && pinUI.mode === "unlock"){
          pinUI.mode = "set1";
          pinUI.buf = "";
          renderPin();
          return;
        }

        if(pinUI.mode === "unlock"){
          const hash = await sha256Hex(rec.salt + ":" + pinUI.buf);
          if(hash === rec.hash){
            state.unlocked = true;
            hidePin();
          } else {
            pinUI.buf = "";
            $("pinHint").textContent = "PIN incorrect.";
            renderPin();
          }
          return;
        }

        if(pinUI.mode === "set1"){
          pinUI.first = pinUI.buf;
          pinUI.buf = "";
          pinUI.mode = "set2";
          $("pinHint").textContent = "";
          renderPin();
          return;
        }

        if(pinUI.mode === "set2"){
          if(pinUI.buf !== pinUI.first){
            pinUI.buf = "";
            pinUI.first = "";
            pinUI.mode = "set1";
            $("pinHint").textContent = "Les deux codes ne correspondent pas. Recommence.";
            renderPin();
            return;
          }
          const salt = randHex(16);
          const hash = await sha256Hex(salt + ":" + pinUI.buf);
          setPinRecord({ salt, hash });
          state.unlocked = true;
          hidePin();
        }
      }

      $("pinCancel").onclick = () => {
        pinUI.mode = "unlock";
        pinUI.buf = "";
        pinUI.first = "";
        renderPin();
      };

      function lock(){
        state.unlocked = false;
        const rec = getPinRecord();
        if(rec) showPin("unlock");
        else showPin("set1");
      }

      $("lockBtn").onclick = () => lock();

      // Init
      load();
      buildKeypad();
      buildLegend();

      const today = new Date();
      state.selectedDate = iso(today);
      state.monthIndex = today.getMonth();

      $("viewSelect").value = state.view;
      $("hint").textContent = "Les jours non saisis restent neutres";

      renderEditor();
      render();

      // Start locked + default journal
      lock();
      setPage("journal");
    })();
  </script>
</body>
</html>
